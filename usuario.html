<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registro — ModularHost</title>
  <style>
    body{font-family:Arial,sans-serif;background:#f5f5f5;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;}
    .form-container{background:#fff;padding:40px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.1);width:100%;max-width:400px;}
    h2{text-align:center;margin-bottom:24px;color:#2563eb;}
    input{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:1px solid #ccc;}
    button{width:100%;padding:12px;margin-top:12px;background:#2563eb;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;}
    button:hover{background:#1d4ed8;}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;}
    .modal-content{background:#fff;padding:30px;border-radius:12px;max-width:400px;width:100%;}
  </style>
</head>
<body>
  <div class="form-container">
    <h2>Registro Usuario</h2>
    <input type="text" id="fullname" placeholder="Nombre completo">
    <input type="text" id="username" placeholder="Nombre de usuario">
    <input type="email" id="email" placeholder="Correo electrónico">
    <input type="password" id="password" placeholder="Contraseña (mínimo 6 caracteres)">
    <button id="registerBtn">Registrar</button>
  </div>

  <div class="modal" id="loginModal">
    <div class="modal-content">
      <h2>Iniciar Sesión</h2>
      <input type="text" id="loginUsername" placeholder="Nombre de usuario">
      <input type="password" id="loginPassword" placeholder="Contraseña">
      <button id="loginBtn">Iniciar Sesión</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getFirestore, collection, addDoc, getDocs, query, where } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyAQHwo1RwucIRAIlqpo3GgRJNmnQlXoNDM",
      authDomain: "album-bc4e1.firebaseapp.com",
      projectId: "album-bc4e1",
      storageBucket: "album-bc4e1.firebasestorage.app",
      messagingSenderId: "1041635546059",
      appId: "1:1041635546059:web:79ff3e516a50b5190ddc4e",
      measurementId: "G-RWGW4F6JCT"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Validar correo electrónico
    function isValidEmail(email) {
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      return emailRegex.test(email);
    }

    // REGISTRO
    document.getElementById('registerBtn').addEventListener('click', async () => {
      const fullname = document.getElementById('fullname').value.trim();
      const username = document.getElementById('username').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value.trim();

      console.log('Datos de registro:', { fullname, username, email, password }); // Depuración

      if (!fullname || !username || !email || !password) {
        alert('Todos los campos son obligatorios');
        return;
      }

      if (!isValidEmail(email)) {
        alert('Por favor, ingrese un correo electrónico válido');
        return;
      }

      if (password.length < 6) {
        alert('La contraseña debe tener al menos 6 caracteres');
        return;
      }

      // Verificar si el nombre de usuario ya existe
      const usernameQuery = query(collection(db, 'usuarios'), where('username', '==', username));
      const usernameSnapshot = await getDocs(usernameQuery);
      if (!usernameSnapshot.empty) {
        alert('El nombre de usuario ya está en uso. Elige otro.');
        return;
      }

      try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        console.log('Usuario registrado:', user.uid); // Depuración

        // Guardar datos adicionales en Firestore
        await addDoc(collection(db, 'usuarios'), {
          uid: user.uid,
          fullname,
          username,
          email,
          createdAt: Date.now()
        });

        alert('Usuario registrado correctamente');
        document.getElementById('loginModal').style.display = 'flex';
      } catch (error) {
        console.error('Error en registro:', error.code, error.message); // Depuración
        if (error.code === 'auth/email-already-in-use') {
          alert('El correo electrónico ya está registrado');
        } else if (error.code === 'auth/invalid-email') {
          alert('El correo electrónico no es válido');
        } else if (error.code === 'auth/weak-password') {
          alert('La contraseña es demasiado débil');
        } else {
          alert('Error al registrar: ' + error.message);
        }
      }
    });

    // LOGIN
    document.getElementById('loginBtn').addEventListener('click', async () => {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();

      console.log('Datos de inicio de sesión:', { username, password }); // Depuración

      if (!username || !password) {
        alert('Ingrese nombre de usuario y contraseña');
        return;
      }

      try {
        // Buscar el correo asociado al nombre de usuario
        const usernameQuery = query(collection(db, 'usuarios'), where('username', '==', username));
        const usernameSnapshot = await getDocs(usernameQuery);

        if (usernameSnapshot.empty) {
          alert('Nombre de usuario no encontrado');
          return;
        }

        const userDoc = usernameSnapshot.docs[0].data();
        const email = userDoc.email;
        console.log('Correo encontrado:', email); // Depuración

        // Iniciar sesión con correo y contraseña
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        console.log('Usuario autenticado:', userCredential.user.uid);
        window.location.href = 'index.html';
      } catch (error) {
        console.error('Error en inicio de sesión:', error.code, error.message); // Depuración
        if (error.code === 'auth/wrong-password') {
          alert('Contraseña incorrecta');
        } else if (error.code === 'auth/user-not-found') {
          alert('Usuario no encontrado');
        } else {
          alert('Error al iniciar sesión: ' + error.message);
        }
      }
    });
  </script>
</body>
</html>